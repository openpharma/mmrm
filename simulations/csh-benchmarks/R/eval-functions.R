################################################################################
## Evaluator Functions
################################################################################

#' Extract correlation matrix from model fits
#'
#' @description Extracts the repeated measures' covariance matrix estimated by
#'   the various fitting procedures.
#'
#' @param fit An object returned by either the mrmm_wrapper_fun(),
#'   glmmTMB_wrapper_fun() or nlme_wrapper_fun().
#'
#' @return The fit argument's estimated repeated measures covariance matrix.
get_covar_mat <- function(fit) {

  ## extract the covariance matrix from the fit object
  if (class(fit)[1] == "gls") {
    covar_mat <- nlme::getVarCov(fit)
  } else if (class(fit)[1] == "glmmTMB") {
    corr_fit_attributes <- attributes(VarCorr(fit)[["cond"]]$participant)
    corr_mat <- corr_fit_attributes$correlation
    out_stddev_mat <- outer(corr_fit_attributes$stddev, corr_fit_attributes$stddev)
    covar_mat <- corr_mat * out_stddev_mat
  } else if (class(fit)[1] == "mmrm") {
    covar_mat <- fit$cov
  }

  ## standardize row and column names
  rownames(covar_mat) <- NULL
  colnames(covar_mat) <- NULL

  ## standardize matrix type
  covar_mat <- as.matrix(covar_mat)

  return(covar_mat)
}

#' Compute the Frobenius norm losses
#'
#' @description This function computes the Frobenius norm loss of each
#'   covariance matrix estimate. This loss is the sum of element-wise squared
#'   errors.
#'
#' @param fit_results A tibble of simulation replicates generated by simChef. It
#'   contains the fitted mixed models for all model implementations.
#'  @param true_covar_mat_ls A named list containing the true repeated measures
#'   covariance matrices associated with each data-generating process. The
#'   matrices' names must match those of the data-generating processes.
#'
#' @return A tibble of simulation replicates containing the Frobenius loss of
#'   every model fit.
frobenius_loss_fun <- function(fit_results, true_covar_mat_ls) {

  fit_results %>%
    dplyr::mutate(
      frobenius_loss = purrr::map2_dbl(
        fit, .dgp_name,
        function(f, dgp_name) {
          est_covar_mat <- get_covar_mat(f)
          true_covar_mat <- true_covar_mat_ls[[dgp_name]]
          norm(est_covar_mat - true_covar_mat, type = "F")
        }
      )
    ) %>%
    dplyr::select(-fit)

}

#' Compute the Spectral norm losses
#'
#' @description This function computes the spectral norm loss of each covariance
#'   matrix estimate. This loss is the absolute largest eigenvalue of the
#'   difference between the estimated and true repeated measures covariance
#'   matrix.
#'
#' @param fit_results A tibble of simulation replicates generated by simChef. It
#'   contains the fitted mixed models for all model implementations.
#'  @param true_covar_mat_ls A named list containing the true repeated measures
#'   covariance matrices associated with each data-generating process. The
#'   matrices' names must match those of the data-generating processes.
#'
#' @return A tibble of simulation replicates containing the Frobenius loss of
#'   every model fit.
spectral_loss_fun <- function(fit_results, true_covar_mat_ls) {

  fit_results %>%
    dplyr::mutate(
      spectral_loss = purrr::map2_dbl(
        fit, .dgp_name,
        function(f, dgp_name) {
          est_covar_mat <- get_covar_mat(f)
          true_covar_mat <- true_covar_mat_ls[[dgp_name]]
          norm(est_covar_mat - true_covar_mat, type = "2")
        }
      )
    ) %>%
    dplyr::select(-fit)

}
