<!DOCTYPE html>
<!-- Generated by pkgdown + https://github.com/insightsengineering/r-pkgdown-multiversion -->
<html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Details of Weighted Least Square Empirical Covariance • mmrm</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.4.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.4.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Details of Weighted Least Square Empirical Covariance">
<!-- Global site tag (gtag.js) - Google Analytics --><script async src="https://www.googletagmanager.com/gtag/js?id=UA-125641273-1"></script><script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-125641273-1');
</script>
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">mmrm</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.3.14</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles">
<li><hr class="dropdown-divider"></li>
    <li><h6 class="dropdown-header" data-toc-skip>Introduction</h6></li>
    <li><a class="dropdown-item" href="../articles/introduction.html">Package Introduction</a></li>
    <li><a class="dropdown-item" href="../articles/methodological_introduction.html">Mixed Models for Repeated Measures</a></li>
    <li><a class="dropdown-item" href="../articles/mmrm_review_methods.html">Comparison with other software</a></li>
    <li><hr class="dropdown-divider"></li>
    <li><h6 class="dropdown-header" data-toc-skip>Covariance Structures</h6></li>
    <li><a class="dropdown-item" href="../articles/covariance.html">Covariance Structures</a></li>
    <li><hr class="dropdown-divider"></li>
    <li><h6 class="dropdown-header" data-toc-skip>Degrees of Freedom and Testing</h6></li>
    <li><a class="dropdown-item" href="../articles/hypothesis_testing.html">Details of Hypothesis Testing</a></li>
    <li><a class="dropdown-item" href="../articles/between_within.html">Between-Within</a></li>
    <li><a class="dropdown-item" href="../articles/kenward.html">Kenward-Roger</a></li>
    <li><a class="dropdown-item" href="../articles/satterthwaite.html">Satterthwaite</a></li>
    <li><hr class="dropdown-divider"></li>
    <li><h6 class="dropdown-header" data-toc-skip>Coefficient Covariance</h6></li>
    <li><a class="dropdown-item" href="../articles/coef_vcov.html">Coefficients Covariance Matrix Adjustment</a></li>
    <li><a class="dropdown-item" href="../articles/empirical_wls.html">Details of Weighted Least Square Empirical Covariance</a></li>
    <li><hr class="dropdown-divider"></li>
    <li><h6 class="dropdown-header" data-toc-skip>Algorithm Details</h6></li>
    <li><a class="dropdown-item" href="../articles/algorithm.html">Model Fitting Algorithm</a></li>
    <li><a class="dropdown-item" href="../articles/predict.html">Prediction and Simulation</a></li>
    <li><hr class="dropdown-divider"></li>
    <li><h6 class="dropdown-header" data-toc-skip>Developers</h6></li>
    <li><a class="dropdown-item" href="../articles/package_structure.html">Package Structure</a></li>
  </ul>
</li>
<li class="nav-item"><a class="nav-link" href="../news/index.html">Changelog</a></li>
<!-- start dropdown for versions --> <li class="nav-item dropdown">
    <a href="#" class="nav-link dropdown-toggle" data-bs-toggle="dropdown" role="button" aria-expanded="false" aria-haspopup="true" id="dropdown-versions">Versions</a>
    <div class="dropdown-menu" aria-labelledby="dropdown-versions">
    <a class="dropdown-item" data-toggle="tooltip" title="" href="https://openpharma.github.io/mmrm/main">main</a>
<a class="dropdown-item" data-toggle="tooltip" title="" href="https://openpharma.github.io/mmrm/latest-tag">latest-tag</a>
<a class="dropdown-item" data-toggle="tooltip" title="" href="https://openpharma.github.io/mmrm/v0.3.14">v0.3.14</a>
<a class="dropdown-item" data-toggle="tooltip" title="" href="https://openpharma.github.io/mmrm/v0.3.13">v0.3.13</a>
<a class="dropdown-item" data-toggle="tooltip" title="" href="https://openpharma.github.io/mmrm/v0.3.12">v0.3.12</a>
<a class="dropdown-item" data-toggle="tooltip" title="" href="https://openpharma.github.io/mmrm/v0.3.11">v0.3.11</a>
<a class="dropdown-item" data-toggle="tooltip" title="" href="https://openpharma.github.io/mmrm/v0.3.10">v0.3.10</a>
<a class="dropdown-item" data-toggle="tooltip" title="" href="https://openpharma.github.io/mmrm/v0.3.7">v0.3.7</a>
<a class="dropdown-item" data-toggle="tooltip" title="" href="https://openpharma.github.io/mmrm/v0.3.6">v0.3.6</a>
<a class="dropdown-item" data-toggle="tooltip" title="" href="https://openpharma.github.io/mmrm/v0.3.5">v0.3.5</a>
<a class="dropdown-item" data-toggle="tooltip" title="" href="https://openpharma.github.io/mmrm/v0.3.4">v0.3.4</a>
<a class="dropdown-item" data-toggle="tooltip" title="" href="https://openpharma.github.io/mmrm/v0.3.3">v0.3.3</a>
<a class="dropdown-item" data-toggle="tooltip" title="" href="https://openpharma.github.io/mmrm/v0.3.2">v0.3.2</a>
<a class="dropdown-item" data-toggle="tooltip" title="" href="https://openpharma.github.io/mmrm/v0.3.1">v0.3.1</a>
<a class="dropdown-item" data-toggle="tooltip" title="" href="https://openpharma.github.io/mmrm/v0.3.0">v0.3.0</a>
<a class="dropdown-item" data-toggle="tooltip" title="" href="https://openpharma.github.io/mmrm/v0.2.2">v0.2.2</a>
</div>
</li>
<!-- end dropdown for versions -->
<li class="nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-reports" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Reports</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-reports">
<li><a class="dropdown-item" href="../coverage-report/">Coverage report</a></li>
    <li><a class="dropdown-item" href="../unit-test-report/">Unit test report</a></li>
  </ul>
</li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/openpharma/mmrm"><span class="fa fa-github"></span></a></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="../logo.svg" class="logo" alt=""><h1>Details of Weighted Least Square Empirical Covariance</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/openpharma/mmrm/blob/v0.3.14/vignettes/empirical_wls.Rmd" class="external-link"><code>vignettes/empirical_wls.Rmd</code></a></small>
      <div class="d-none name"><code>empirical_wls.Rmd</code></div>
    </div>

    
    
<div class="section level2">
<h2 id="weighted-least-square-wls-empirical-covariance">Weighted Least Square (WLS) Empirical Covariance<a class="anchor" aria-label="anchor" href="#weighted-least-square-wls-empirical-covariance"></a>
</h2>
<p>Following the notation we have without weights, <span class="citation">Bell and McCaffrey (2002)</span> and <span class="citation">Pustejovsky and Tipton (2018)</span> suggest</p>
<p><math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>v</mi><mo>=</mo><mi>s</mi><msup><mi>C</mi><mi>⊤</mi></msup><msup><mrow><mo stretchy="true" form="prefix">(</mo><msup><mi>X</mi><mi>⊤</mi></msup><mi>W</mi><mi>X</mi><mo stretchy="true" form="postfix">)</mo></mrow><mrow><mi>−</mi><mn>1</mn></mrow></msup><munder><mo>∑</mo><mi>i</mi></munder><mrow><msubsup><mi>X</mi><mi>i</mi><mi>⊤</mi></msubsup><msub><mi>W</mi><mi>i</mi></msub><msub><mi>A</mi><mi>i</mi></msub><msub><mi>ϵ</mi><mi>i</mi></msub><msubsup><mi>ϵ</mi><mi>i</mi><mi>⊤</mi></msubsup><msub><mi>A</mi><mi>i</mi></msub><msub><mi>W</mi><mi>i</mi></msub><msub><mi>X</mi><mi>i</mi></msub></mrow><msup><mrow><mo stretchy="true" form="prefix">(</mo><msup><mi>X</mi><mi>⊤</mi></msup><mi>W</mi><mi>X</mi><mo stretchy="true" form="postfix">)</mo></mrow><mrow><mi>−</mi><mn>1</mn></mrow></msup><mi>C</mi></mrow><annotation encoding="application/x-tex">
  v = s C^\top(X^\top W X)^{-1}\sum_{i}{X_i^\top W_i A_i \epsilon_i \epsilon_i^\top A_i W_i X_i} (X^\top W X)^{-1} C
</annotation></semantics></math></p>
<p>where
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>A</mi><mi>i</mi></msub><annotation encoding="application/x-tex">A_i</annotation></semantics></math>
takes
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>I</mi><mi>i</mi></msub><annotation encoding="application/x-tex">I_i</annotation></semantics></math>,
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msup><mrow><mo stretchy="true" form="prefix">(</mo><msub><mi>I</mi><mi>i</mi></msub><mo>−</mo><msub><mi>H</mi><mrow><mi>i</mi><mi>i</mi></mrow></msub><mo stretchy="true" form="postfix">)</mo></mrow><mrow><mi>−</mi><mfrac><mn>1</mn><mn>2</mn></mfrac></mrow></msup><annotation encoding="application/x-tex">(I_i - H_{ii})^{-\frac{1}{2}}</annotation></semantics></math>,
or
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msup><mrow><mo stretchy="true" form="prefix">(</mo><msub><mi>I</mi><mi>i</mi></msub><mo>−</mo><msub><mi>H</mi><mrow><mi>i</mi><mi>i</mi></mrow></msub><mo stretchy="true" form="postfix">)</mo></mrow><mrow><mi>−</mi><mn>1</mn></mrow></msup><annotation encoding="application/x-tex">(I_i - H_{ii})^{-1}</annotation></semantics></math>
is unchanged, but
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>H</mi><annotation encoding="application/x-tex">H</annotation></semantics></math>
is changed</p>
<p><math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>H</mi><mo>=</mo><mi>X</mi><msup><mrow><mo stretchy="true" form="prefix">(</mo><msup><mi>X</mi><mi>⊤</mi></msup><mi>W</mi><mi>X</mi><mo stretchy="true" form="postfix">)</mo></mrow><mrow><mi>−</mi><mn>1</mn></mrow></msup><msup><mi>X</mi><mi>⊤</mi></msup><mi>W</mi></mrow><annotation encoding="application/x-tex">
  H = X (X^\top W X)^{-1} X^\top W
</annotation></semantics></math></p>
<p>For the degrees of freedom, we have</p>
<p><math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>G</mi><mrow><mi>i</mi><mi>j</mi></mrow></msub><mo>=</mo><msubsup><mi>g</mi><mi>i</mi><mi>⊤</mi></msubsup><mi>Φ</mi><msub><mi>g</mi><mi>j</mi></msub></mrow><annotation encoding="application/x-tex">
  G_{ij} = g_i^\top \Phi g_j
</annotation></semantics></math></p>
<p>where</p>
<p><math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>g</mi><mi>i</mi></msub><mo>=</mo><msup><mi>s</mi><mfrac><mn>1</mn><mn>2</mn></mfrac></msup><msubsup><mrow><mo stretchy="true" form="prefix">(</mo><mi>I</mi><mo>−</mo><mi>H</mi><mo stretchy="true" form="postfix">)</mo></mrow><mi>i</mi><mi>⊤</mi></msubsup><msub><mi>A</mi><mi>i</mi></msub><msub><mi>W</mi><mi>i</mi></msub><msub><mi>X</mi><mi>i</mi></msub><msup><mrow><mo stretchy="true" form="prefix">(</mo><msup><mi>X</mi><mi>⊤</mi></msup><mi>X</mi><mo stretchy="true" form="postfix">)</mo></mrow><mrow><mi>−</mi><mn>1</mn></mrow></msup><mi>C</mi></mrow><annotation encoding="application/x-tex">
  g_i = s^{\frac{1}{2}} (I - H)_i^\top A_i W_i X_i (X^\top X)^{-1} C
</annotation></semantics></math></p>
</div>
<div class="section level2">
<h2 id="difference-of-implementations">Difference of Implementations<a class="anchor" aria-label="anchor" href="#difference-of-implementations"></a>
</h2>
<p>Comparing the previous section with our implementation, we can find
out the differences. Since they have nearly the same symbols, to
differentiate the different part, we use subscript
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mn>1</mn><annotation encoding="application/x-tex">1</annotation></semantics></math>
to denote the implementation suggested by <span class="citation">Bell
and McCaffrey (2002)</span> and <span class="citation">Pustejovsky and
Tipton (2018)</span>, and use
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mn>2</mn><annotation encoding="application/x-tex">2</annotation></semantics></math>
to denote the our implementation of covariance estimator in
<code>mmrm</code>, we have</p>
<p><math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>v</mi><mn>1</mn></msub><mo>=</mo><mi>s</mi><msup><mi>C</mi><mi>⊤</mi></msup><msup><mrow><mo stretchy="true" form="prefix">(</mo><msup><mi>X</mi><mi>⊤</mi></msup><mi>W</mi><mi>X</mi><mo stretchy="true" form="postfix">)</mo></mrow><mrow><mi>−</mi><mn>1</mn></mrow></msup><munder><mo>∑</mo><mi>i</mi></munder><mrow><msubsup><mi>X</mi><mi>i</mi><mi>⊤</mi></msubsup><msub><mi>W</mi><mi>i</mi></msub><msub><mi>A</mi><mrow><mn>1</mn><mo>,</mo><mi>i</mi></mrow></msub><msub><mi>ϵ</mi><mi>i</mi></msub><msubsup><mi>ϵ</mi><mi>i</mi><mi>⊤</mi></msubsup><msub><mi>A</mi><mrow><mn>1</mn><mo>,</mo><mi>i</mi></mrow></msub><msub><mi>W</mi><mi>i</mi></msub><msub><mi>X</mi><mi>i</mi></msub></mrow><msup><mrow><mo stretchy="true" form="prefix">(</mo><msup><mi>X</mi><mi>⊤</mi></msup><mi>W</mi><mi>X</mi><mo stretchy="true" form="postfix">)</mo></mrow><mrow><mi>−</mi><mn>1</mn></mrow></msup><mi>C</mi></mrow><annotation encoding="application/x-tex">
  v_{1} = s C^\top(X^\top W X)^{-1}\sum_{i}{X_i^\top W_i A_{1, i} \epsilon_i \epsilon_i^\top A_{1, i} W_i X_i} (X^\top W X)^{-1} C
</annotation></semantics></math></p>
<p><math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>v</mi><mn>2</mn></msub><mo>=</mo><mi>s</mi><msup><mi>C</mi><mi>⊤</mi></msup><msup><mrow><mo stretchy="true" form="prefix">(</mo><msup><mi>X</mi><mi>⊤</mi></msup><mi>W</mi><mi>X</mi><mo stretchy="true" form="postfix">)</mo></mrow><mrow><mi>−</mi><mn>1</mn></mrow></msup><munder><mo>∑</mo><mi>i</mi></munder><mrow><msubsup><mi>X</mi><mi>i</mi><mi>⊤</mi></msubsup><msub><mi>L</mi><mi>i</mi></msub><msub><mi>A</mi><mrow><mn>2</mn><mo>,</mo><mi>i</mi></mrow></msub><msubsup><mi>L</mi><mi>i</mi><mi>⊤</mi></msubsup><msub><mi>ϵ</mi><mi>i</mi></msub><msubsup><mi>ϵ</mi><mi>i</mi><mi>⊤</mi></msubsup><msub><mi>L</mi><mi>i</mi></msub><msub><mi>A</mi><mrow><mn>2</mn><mo>,</mo><mi>i</mi></mrow></msub><msubsup><mi>L</mi><mi>i</mi><mi>⊤</mi></msubsup><msub><mi>X</mi><mi>i</mi></msub></mrow><msup><mrow><mo stretchy="true" form="prefix">(</mo><msup><mi>X</mi><mi>⊤</mi></msup><mi>W</mi><mi>X</mi><mo stretchy="true" form="postfix">)</mo></mrow><mrow><mi>−</mi><mn>1</mn></mrow></msup><mi>C</mi></mrow><annotation encoding="application/x-tex">
  v_{2} = s C^\top(X^\top W X)^{-1}\sum_{i}{X_i^\top L_i A_{2, i} L_i^\top \epsilon_i \epsilon_i^\top L_i A_{2, i} L_i^\top X_i} (X^\top W X)^{-1} C
</annotation></semantics></math></p>
<p>Here we will prove that they are identical.</p>
<div class="section level3">
<h3 id="proof-of-identity">Proof of Identity<a class="anchor" aria-label="anchor" href="#proof-of-identity"></a>
</h3>
<div class="section level4">
<h4 id="proof-for-covariance-estimator">Proof for Covariance Estimator<a class="anchor" aria-label="anchor" href="#proof-for-covariance-estimator"></a>
</h4>
<p>First of all, we assume that all
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>A</mi><mi>i</mi></msub><annotation encoding="application/x-tex">A_i</annotation></semantics></math>
matrix, in any form, are positive-definite. Comparing
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>v</mi><mn>1</mn></msub><annotation encoding="application/x-tex">v_{1}</annotation></semantics></math>
and
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>v</mi><mn>2</mn></msub><annotation encoding="application/x-tex">v_{2}</annotation></semantics></math>,
we see that the different part is</p>
<p><math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>M</mi><mrow><mn>1</mn><mo>,</mo><mi>d</mi><mo>,</mo><mi>i</mi></mrow></msub><mo>=</mo><msub><mi>W</mi><mi>i</mi></msub><msub><mi>A</mi><mrow><mn>1</mn><mo>,</mo><mi>i</mi></mrow></msub></mrow><annotation encoding="application/x-tex">
  M_{1, d, i} = W_i A_{1, i}
</annotation></semantics></math> and
<math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>M</mi><mrow><mn>2</mn><mo>,</mo><mi>d</mi><mo>,</mo><mi>i</mi></mrow></msub><mo>=</mo><msub><mi>L</mi><mi>i</mi></msub><msub><mi>A</mi><mrow><mn>2</mn><mo>,</mo><mi>i</mi></mrow></msub><msubsup><mi>L</mi><mi>i</mi><mi>⊤</mi></msubsup></mrow><annotation encoding="application/x-tex">
  M_{2, d, i} = L_i A_{2, i} L_i^\top
</annotation></semantics></math></p>
<p>Substitute
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>H</mi><mn>1</mn></msub><annotation encoding="application/x-tex">H_{1}</annotation></semantics></math>
and
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>H</mi><mn>2</mn></msub><annotation encoding="application/x-tex">H_{2}</annotation></semantics></math>
with its expression, we have</p>
<p><math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>M</mi><mrow><mn>1</mn><mo>,</mo><mi>d</mi><mo>,</mo><mi>i</mi></mrow></msub><mo>=</mo><msub><mi>W</mi><mi>i</mi></msub><msup><mrow><mo stretchy="true" form="prefix">(</mo><msub><mi>I</mi><mi>i</mi></msub><mo>−</mo><msub><mi>X</mi><mi>i</mi></msub><msup><mrow><mo stretchy="true" form="prefix">(</mo><msup><mi>X</mi><mi>⊤</mi></msup><mi>W</mi><mi>X</mi><mo stretchy="true" form="postfix">)</mo></mrow><mrow><mi>−</mi><mn>1</mn></mrow></msup><msubsup><mi>X</mi><mi>i</mi><mi>⊤</mi></msubsup><msub><mi>W</mi><mi>i</mi></msub><mo stretchy="true" form="postfix">)</mo></mrow><mi>d</mi></msup></mrow><annotation encoding="application/x-tex">
  M_{1, d, i} = W_i (I_i - X_i (X^\top W X)^{-1} X_i^\top W_i)^d
</annotation></semantics></math></p>
<p><math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>M</mi><mrow><mn>2</mn><mo>,</mo><mi>d</mi><mo>,</mo><mi>i</mi></mrow></msub><mo>=</mo><msub><mi>L</mi><mi>i</mi></msub><msup><mrow><mo stretchy="true" form="prefix">(</mo><msub><mi>I</mi><mi>i</mi></msub><mo>−</mo><msubsup><mi>L</mi><mi>i</mi><mi>⊤</mi></msubsup><msub><mi>X</mi><mi>i</mi></msub><msup><mrow><mo stretchy="true" form="prefix">(</mo><msup><mi>X</mi><mi>⊤</mi></msup><mi>W</mi><mi>X</mi><mo stretchy="true" form="postfix">)</mo></mrow><mrow><mi>−</mi><mn>1</mn></mrow></msup><msubsup><mi>X</mi><mi>i</mi><mi>⊤</mi></msubsup><msub><mi>L</mi><mi>i</mi></msub><mo stretchy="true" form="postfix">)</mo></mrow><mi>d</mi></msup><msubsup><mi>L</mi><mi>i</mi><mi>⊤</mi></msubsup></mrow><annotation encoding="application/x-tex">
  M_{2, d, i} = L_i (I_i - L_i^\top X_i (X^\top W X)^{-1} X_i^\top L_i)^d L_i^\top
</annotation></semantics></math></p>
<p>Where
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>d</mi><annotation encoding="application/x-tex">d</annotation></semantics></math>
takes
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mn>0</mn><annotation encoding="application/x-tex">0</annotation></semantics></math>,
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>−</mi><mn>1</mn><mi>/</mi><mn>2</mn></mrow><annotation encoding="application/x-tex">-1/2</annotation></semantics></math>
and
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>−</mi><mn>1</mn></mrow><annotation encoding="application/x-tex">-1</annotation></semantics></math>
respectively.</p>
<p>Apparently, if
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>d</mi><mo>=</mo><mn>0</mn></mrow><annotation encoding="application/x-tex">d=0</annotation></semantics></math>,
these two are identical because
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>W</mi><mi>i</mi></msub><mo>=</mo><msub><mi>L</mi><mi>i</mi></msub><msubsup><mi>L</mi><mi>i</mi><mi>⊤</mi></msubsup></mrow><annotation encoding="application/x-tex">W_i = L_i L_i^\top</annotation></semantics></math>.</p>
<p>When
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>d</mi><mo>=</mo><mi>−</mi><mn>1</mn></mrow><annotation encoding="application/x-tex">d = -1</annotation></semantics></math>,
we have</p>
<p><span class="math display">$$
  M_{2, -1, i} = L_i (I_i - L_i^\top X_i (X^\top W X)^{-1} X_i^\top
L_i)^{-1} L_i^\top \\
  = (L_i^{-1})^{-1} (I_i - L_i^\top X_i (X^\top W X)^{-1} X_i^\top
L_i)^{-1} ((L_i^\top)^{-1})^{-1} \\
  = [((L_i^\top)^{-1})(I_i - L_i^\top X_i (X^\top W X)^{-1} X_i^\top
L_i)(L_i^{-1})]^{-1} \\
  = [(L_i^\top)^{-1}L_i^{-1} - X_i (X^\top W X)^{-1} X_i^\top]^{-1} \\
  = (W_i^{-1} -  X_i (X^\top W X)^{-1} X_i^\top)^{-1}
$$</span></p>
<p><span class="math display">$$
  M_{1, -1, i} = W_i (I_i - X_i (X^\top W X)^{-1} X_i^\top W_i)^{-1} \\
  = (W_i^{-1})^{-1} (I_i - X_i (X^\top W X)^{-1} X_i^\top W_i)^{-1} \\
  = [(I_i - X_i (X^\top W X)^{-1} X_i^\top W_i)((W_i^{-1}))]^{-1} \\
  = (W_i^{-1} -  X_i (X^\top W X)^{-1} X_i^\top)^{-1}
$$</span></p>
<p>Obviously,
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>M</mi><mrow><mn>2</mn><mo>,</mo><mi>−</mi><mn>1</mn><mo>,</mo><mi>i</mi></mrow></msub><mo>=</mo><msub><mi>M</mi><mrow><mn>1</mn><mo>,</mo><mi>−</mi><mn>1</mn><mo>,</mo><mi>i</mi></mrow></msub></mrow><annotation encoding="application/x-tex">M_{2, -1, i} = M_{1, -1, i}</annotation></semantics></math>,
and use the following notation</p>
<p><math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>M</mi><mrow><mn>2</mn><mo>,</mo><mi>−</mi><mn>1</mn><mo>,</mo><mi>i</mi></mrow></msub><mo>=</mo><msub><mi>L</mi><mi>i</mi></msub><msub><mi>B</mi><mrow><mn>2</mn><mo>,</mo><mi>i</mi></mrow></msub><msubsup><mi>L</mi><mi>i</mi><mi>⊤</mi></msubsup></mrow><annotation encoding="application/x-tex">
  M_{2, -1, i} = L_i B_{2, i} L_i^\top
</annotation></semantics></math></p>
<p><math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>M</mi><mrow><mn>1</mn><mo>,</mo><mi>−</mi><mn>1</mn><mo>,</mo><mi>i</mi></mrow></msub><mo>=</mo><msub><mi>W</mi><mi>i</mi></msub><msub><mi>B</mi><mrow><mn>1</mn><mo>,</mo><mi>i</mi></mrow></msub></mrow><annotation encoding="application/x-tex">
  M_{1, -1, i} = W_i B_{1, i}
</annotation></semantics></math></p>
<p>we have</p>
<p><span class="math display">$$
  B_{1, i} = W_i^{-1} L_i B_{2, i} L_i^\top \\
  = (L_i^\top)^{-1} B_{2, i} L_i^\top
$$</span></p>
<p>When
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>d</mi><mo>=</mo><mi>−</mi><mn>1</mn><mi>/</mi><mn>2</mn></mrow><annotation encoding="application/x-tex">d = -1/2</annotation></semantics></math>,
we have the following</p>
<p><span class="math display">$$
  M_{2, -1/2, i} = L_i (I_i - L_i^\top X_i (X^\top W X)^{-1} X_i^\top
L_i)^{-1/2} L_i^\top \\
  = L_i B_{2, i}^{1/2} L_i^\top
$$</span></p>
<p><span class="math display">$$
  M_{1, -1/2, i} = W_i (I_i - X_i (X^\top W X)^{-1} X_i^\top W_i)^{-1/2}
\\
  = W_i B_{1, i}^{1/2}
$$</span></p>
<p>Apparently if
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msubsup><mi>B</mi><mrow><mn>1</mn><mo>,</mo><mi>i</mi></mrow><mrow><mn>1</mn><mi>/</mi><mn>2</mn></mrow></msubsup><mo>≠</mo><msup><mrow><mo stretchy="true" form="prefix">(</mo><msubsup><mi>L</mi><mi>i</mi><mi>⊤</mi></msubsup><mo stretchy="true" form="postfix">)</mo></mrow><mrow><mi>−</mi><mn>1</mn></mrow></msup><msubsup><mi>B</mi><mrow><mn>2</mn><mo>,</mo><mi>i</mi></mrow><mrow><mn>1</mn><mi>/</mi><mn>2</mn></mrow></msubsup><msubsup><mi>L</mi><mi>i</mi><mi>⊤</mi></msubsup></mrow><annotation encoding="application/x-tex">B_{1, i}^{1/2} \ne (L_i^\top)^{-1} B_{2, i}^{1/2} L_i^\top</annotation></semantics></math>,
we should also have
<math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msubsup><mi>B</mi><mrow><mn>1</mn><mo>,</mo><mi>i</mi></mrow><mrow><mn>1</mn><mi>/</mi><mn>2</mn></mrow></msubsup><msubsup><mi>B</mi><mrow><mn>1</mn><mo>,</mo><mi>i</mi></mrow><mrow><mn>1</mn><mi>/</mi><mn>2</mn></mrow></msubsup><mo>≠</mo><msup><mrow><mo stretchy="true" form="prefix">(</mo><msubsup><mi>L</mi><mi>i</mi><mi>⊤</mi></msubsup><mo stretchy="true" form="postfix">)</mo></mrow><mrow><mi>−</mi><mn>1</mn></mrow></msup><msubsup><mi>B</mi><mrow><mn>2</mn><mo>,</mo><mi>i</mi></mrow><mrow><mn>1</mn><mi>/</mi><mn>2</mn></mrow></msubsup><msubsup><mi>L</mi><mi>i</mi><mi>⊤</mi></msubsup><msup><mrow><mo stretchy="true" form="prefix">(</mo><msubsup><mi>L</mi><mi>i</mi><mi>⊤</mi></msubsup><mo stretchy="true" form="postfix">)</mo></mrow><mrow><mi>−</mi><mn>1</mn></mrow></msup><msubsup><mi>B</mi><mrow><mn>2</mn><mo>,</mo><mi>i</mi></mrow><mrow><mn>1</mn><mi>/</mi><mn>2</mn></mrow></msubsup><msubsup><mi>L</mi><mi>i</mi><mi>⊤</mi></msubsup></mrow><annotation encoding="application/x-tex">
  B_{1, i}^{1/2} B_{1, i}^{1/2} \ne (L_i^\top)^{-1} B_{2, i}^{1/2} L_i^\top (L_i^\top)^{-1} B_{2, i}^{1/2} L_i^\top
</annotation></semantics></math></p>
<p>leading to</p>
<p><math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>B</mi><mrow><mn>1</mn><mo>,</mo><mi>i</mi></mrow></msub><mo>≠</mo><msup><mrow><mo stretchy="true" form="prefix">(</mo><msubsup><mi>L</mi><mi>i</mi><mi>⊤</mi></msubsup><mo stretchy="true" form="postfix">)</mo></mrow><mrow><mi>−</mi><mn>1</mn></mrow></msup><msub><mi>B</mi><mrow><mn>2</mn><mo>,</mo><mi>i</mi></mrow></msub><msubsup><mi>L</mi><mi>i</mi><mi>⊤</mi></msubsup></mrow><annotation encoding="application/x-tex">
  B_{1, i} \ne (L_i^\top)^{-1} B_{2, i} L_i^\top
</annotation></semantics></math></p>
<p>which is contradictory with our previous result. Thus, these
covariance estimator are identical.</p>
</div>
<div class="section level4">
<h4 id="proof-for-degrees-of-freedom">Proof for Degrees of Freedom<a class="anchor" aria-label="anchor" href="#proof-for-degrees-of-freedom"></a>
</h4>
<p>To prove
<math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>G</mi><mrow><mn>1</mn><mo>,</mo><mi>i</mi><mi>j</mi></mrow></msub><mo>=</mo><msubsup><mi>g</mi><mrow><mn>1</mn><mo>,</mo><mi>i</mi></mrow><mi>⊤</mi></msubsup><mi>Φ</mi><msub><mi>g</mi><mrow><mn>1</mn><mo>,</mo><mi>j</mi></mrow></msub></mrow><annotation encoding="application/x-tex">
  G_{1, ij} = g_{1, i}^\top \Phi g_{1, j}
</annotation></semantics></math> and
<math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>G</mi><mrow><mn>2</mn><mo>,</mo><mi>i</mi><mi>j</mi></mrow></msub><mo>=</mo><msubsup><mi>g</mi><mrow><mn>2</mn><mo>,</mo><mi>i</mi></mrow><mi>⊤</mi></msubsup><msub><mi>g</mi><mrow><mn>2</mn><mo>,</mo><mi>j</mi></mrow></msub></mrow><annotation encoding="application/x-tex">
  G_{2, ij} = g_{2, i}^\top g_{2, j}
</annotation></semantics></math> are identical, we only need to prove
that</p>
<p><math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msup><mi>L</mi><mrow><mi>−</mi><mn>1</mn></mrow></msup><msub><mi>g</mi><mrow><mn>1</mn><mo>,</mo><mi>i</mi></mrow></msub><mo>=</mo><msub><mi>g</mi><mrow><mi>m</mi><mi>m</mi><mi>r</mi><msub><mi>m</mi><mi>i</mi></msub></mrow></msub></mrow><annotation encoding="application/x-tex">
  L^{-1} g_{1, i} = g_{mmrm_i}
</annotation></semantics></math></p>
<p>where
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>Φ</mi><mo>=</mo><msup><mi>W</mi><mrow><mi>−</mi><mn>1</mn></mrow></msup></mrow><annotation encoding="application/x-tex">\Phi = W^{-1}</annotation></semantics></math>
according to our previous expression.</p>
<p>We first expand
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msup><mi>L</mi><mrow><mi>−</mi><mn>1</mn></mrow></msup><msub><mi>g</mi><mrow><mn>1</mn><mo>,</mo><mi>i</mi></mrow></msub></mrow><annotation encoding="application/x-tex">L^{-1} g_{1, i}</annotation></semantics></math>
and
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>g</mi><mrow><mi>m</mi><mi>m</mi><mi>r</mi><msub><mi>m</mi><mi>i</mi></msub></mrow></msub><annotation encoding="application/x-tex">g_{mmrm_i}</annotation></semantics></math></p>
<p><math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msup><mi>L</mi><mrow><mi>−</mi><mn>1</mn></mrow></msup><msub><mi>g</mi><mrow><mn>1</mn><mo>,</mo><mi>i</mi></mrow></msub><mo>=</mo><msup><mi>L</mi><mrow><mi>−</mi><mn>1</mn></mrow></msup><mrow><mo stretchy="true" form="prefix">(</mo><mi>I</mi><mo>−</mo><mi>X</mi><msup><mrow><mo stretchy="true" form="prefix">(</mo><msup><mi>X</mi><mi>⊤</mi></msup><mi>W</mi><mi>X</mi><mo stretchy="true" form="postfix">)</mo></mrow><mrow><mi>−</mi><mn>1</mn></mrow></msup><msup><mi>X</mi><mi>⊤</mi></msup><mi>W</mi><mo stretchy="true" form="postfix">)</mo></mrow><msubsup><mi>S</mi><mi>i</mi><mi>⊤</mi></msubsup><msubsup><mi>A</mi><mrow><mn>1</mn><mo>,</mo><mi>i</mi></mrow><mi>d</mi></msubsup><msub><mi>W</mi><mi>i</mi></msub><msub><mi>X</mi><mi>i</mi></msub><msup><mrow><mo stretchy="true" form="prefix">(</mo><msup><mi>X</mi><mi>⊤</mi></msup><mi>W</mi><mi>X</mi><mo stretchy="true" form="postfix">)</mo></mrow><mrow><mi>−</mi><mn>1</mn></mrow></msup><mi>C</mi></mrow><annotation encoding="application/x-tex">
  L^{-1} g_{1, i} = L^{-1} (I - X(X^\top W X)^{-1}X^\top W) S_i^\top A_{1, i}^d W_i X_i (X^\top W X)^{-1} C
</annotation></semantics></math></p>
<p><math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>g</mi><mrow><mn>2</mn><mo>,</mo><mi>i</mi></mrow></msub><mo>=</mo><mrow><mo stretchy="true" form="prefix">(</mo><mi>I</mi><mo>−</mo><msubsup><mi>L</mi><mi>i</mi><mi>⊤</mi></msubsup><mi>X</mi><msup><mrow><mo stretchy="true" form="prefix">(</mo><msup><mi>X</mi><mi>⊤</mi></msup><mi>W</mi><mi>X</mi><mo stretchy="true" form="postfix">)</mo></mrow><mrow><mi>−</mi><mn>1</mn></mrow></msup><msup><mi>X</mi><mi>⊤</mi></msup><msub><mi>L</mi><mi>i</mi></msub><mo stretchy="true" form="postfix">)</mo></mrow><msubsup><mi>S</mi><mi>i</mi><mi>⊤</mi></msubsup><msubsup><mi>A</mi><mrow><mn>2</mn><mo>,</mo><mi>i</mi></mrow><mi>d</mi></msubsup><msubsup><mi>L</mi><mi>i</mi><mi>⊤</mi></msubsup><msub><mi>X</mi><mi>i</mi></msub><msup><mrow><mo stretchy="true" form="prefix">(</mo><msup><mi>X</mi><mi>⊤</mi></msup><mi>W</mi><mi>X</mi><mo stretchy="true" form="postfix">)</mo></mrow><mrow><mi>−</mi><mn>1</mn></mrow></msup><mi>C</mi></mrow><annotation encoding="application/x-tex">
  g_{2, i} = (I - L_i^\top X(X^\top W X)^{-1}X^\top L_i) S_i^\top A_{2, i}^d L_i^\top X_i (X^\top W X)^{-1} C
</annotation></semantics></math></p>
<p>where
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>S</mi><mi>i</mi></msub><annotation encoding="application/x-tex">S_i</annotation></semantics></math>
is the row selection matrix.</p>
<p>We will prove the inner part equal
<math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msup><mi>L</mi><mrow><mi>−</mi><mn>1</mn></mrow></msup><mrow><mo stretchy="true" form="prefix">(</mo><mi>I</mi><mo>−</mo><mi>X</mi><msup><mrow><mo stretchy="true" form="prefix">(</mo><msup><mi>X</mi><mi>⊤</mi></msup><mi>W</mi><mi>X</mi><mo stretchy="true" form="postfix">)</mo></mrow><mrow><mi>−</mi><mn>1</mn></mrow></msup><msup><mi>X</mi><mi>⊤</mi></msup><mi>W</mi><mo stretchy="true" form="postfix">)</mo></mrow><msubsup><mi>S</mi><mi>i</mi><mi>⊤</mi></msubsup><msubsup><mi>A</mi><mrow><mn>1</mn><mo>,</mo><mi>i</mi></mrow><mi>d</mi></msubsup><msub><mi>W</mi><mi>i</mi></msub><mo>=</mo><mrow><mo stretchy="true" form="prefix">(</mo><mi>I</mi><mo>−</mo><msup><mi>L</mi><mi>⊤</mi></msup><mi>X</mi><msup><mrow><mo stretchy="true" form="prefix">(</mo><msup><mi>X</mi><mi>⊤</mi></msup><mi>W</mi><mi>X</mi><mo stretchy="true" form="postfix">)</mo></mrow><mrow><mi>−</mi><mn>1</mn></mrow></msup><msup><mi>X</mi><mi>⊤</mi></msup><mi>L</mi><mo stretchy="true" form="postfix">)</mo></mrow><msubsup><mi>S</mi><mi>i</mi><mi>⊤</mi></msubsup><msubsup><mi>A</mi><mrow><mn>2</mn><mo>,</mo><mi>i</mi></mrow><mi>d</mi></msubsup><msubsup><mi>L</mi><mi>i</mi><mi>⊤</mi></msubsup></mrow><annotation encoding="application/x-tex">
  L^{-1} (I - X(X^\top W X)^{-1}X^\top W) S_i^\top A_{1, i}^d W_i = (I - L^\top X(X^\top W X)^{-1}X^\top L) S_i^\top A_{2, i}^d L_i^\top
</annotation></semantics></math></p>
<p>With the previous proof of covariance estimators, we already have</p>
<p><math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>M</mi><mrow><mn>1</mn><mo>,</mo><mi>d</mi><mo>,</mo><mi>i</mi></mrow></msub><mo>=</mo><msub><mi>W</mi><mi>i</mi></msub><msubsup><mi>A</mi><mrow><mn>1</mn><mo>,</mo><mi>i</mi></mrow><mi>d</mi></msubsup><mo>=</mo><msub><mi>L</mi><mi>i</mi></msub><msubsup><mi>A</mi><mrow><mn>2</mn><mo>,</mo><mi>i</mi></mrow><mi>d</mi></msubsup><msubsup><mi>L</mi><mi>i</mi><mi>⊤</mi></msubsup><mo>=</mo><msub><mi>M</mi><mrow><mn>2</mn><mo>,</mo><mi>d</mi><mo>,</mo><mi>i</mi></mrow></msub></mrow><annotation encoding="application/x-tex">
  M_{1, d, i} = W_i A_{1, i}^d = L_i A_{2, i}^d L_i^\top = M_{2, d, i}
</annotation></semantics></math> we then need to prove
<math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msup><mi>L</mi><mrow><mi>−</mi><mn>1</mn></mrow></msup><mrow><mo stretchy="true" form="prefix">(</mo><mi>I</mi><mo>−</mo><mi>X</mi><msup><mrow><mo stretchy="true" form="prefix">(</mo><msup><mi>X</mi><mi>⊤</mi></msup><mi>W</mi><mi>X</mi><mo stretchy="true" form="postfix">)</mo></mrow><mrow><mi>−</mi><mn>1</mn></mrow></msup><msup><mi>X</mi><mi>⊤</mi></msup><mi>W</mi><mo stretchy="true" form="postfix">)</mo></mrow><msubsup><mi>S</mi><mi>i</mi><mi>⊤</mi></msubsup><mo>=</mo><mrow><mo stretchy="true" form="prefix">(</mo><mi>I</mi><mo>−</mo><msup><mi>L</mi><mi>⊤</mi></msup><mi>X</mi><msup><mrow><mo stretchy="true" form="prefix">(</mo><msup><mi>X</mi><mi>⊤</mi></msup><mi>W</mi><mi>X</mi><mo stretchy="true" form="postfix">)</mo></mrow><mrow><mi>−</mi><mn>1</mn></mrow></msup><msup><mi>X</mi><mi>⊤</mi></msup><mi>L</mi><mo stretchy="true" form="postfix">)</mo></mrow><msubsup><mi>S</mi><mi>i</mi><mi>⊤</mi></msubsup><msubsup><mi>L</mi><mi>i</mi><mrow><mi>−</mi><mn>1</mn></mrow></msubsup></mrow><annotation encoding="application/x-tex">
  L^{-1} (I - X(X^\top W X)^{-1}X^\top W) S_i^\top = (I - L^\top X(X^\top W X)^{-1}X^\top L) S_i^\top L_i^{-1}
</annotation></semantics></math></p>
<p>and note the relationship between
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="true" form="prefix">(</mo><mi>I</mi><mo>−</mo><mi>X</mi><msup><mrow><mo stretchy="true" form="prefix">(</mo><msup><mi>X</mi><mi>⊤</mi></msup><mi>W</mi><mi>X</mi><mo stretchy="true" form="postfix">)</mo></mrow><mrow><mi>−</mi><mn>1</mn></mrow></msup><msup><mi>X</mi><mi>⊤</mi></msup><mi>W</mi><mo stretchy="true" form="postfix">)</mo></mrow><annotation encoding="application/x-tex">(I - X(X^\top W X)^{-1}X^\top W)</annotation></semantics></math>
and
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="true" form="prefix">(</mo><mi>I</mi><mo>−</mo><msup><mi>L</mi><mi>⊤</mi></msup><mi>X</mi><msup><mrow><mo stretchy="true" form="prefix">(</mo><msup><mi>X</mi><mi>⊤</mi></msup><mi>W</mi><mi>X</mi><mo stretchy="true" form="postfix">)</mo></mrow><mrow><mi>−</mi><mn>1</mn></mrow></msup><msup><mi>X</mi><mi>⊤</mi></msup><mi>L</mi><mo stretchy="true" form="postfix">)</mo></mrow><annotation encoding="application/x-tex">(I - L^\top X(X^\top W X)^{-1}X^\top L)</annotation></semantics></math>
has already been proved in covariance estimator section, we only need to
prove</p>
<p><math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msup><mi>L</mi><mrow><mi>−</mi><mn>1</mn></mrow></msup><mrow><mo stretchy="true" form="prefix">(</mo><mi>I</mi><mo>−</mo><mi>X</mi><msup><mrow><mo stretchy="true" form="prefix">(</mo><msup><mi>X</mi><mi>⊤</mi></msup><mi>W</mi><mi>X</mi><mo stretchy="true" form="postfix">)</mo></mrow><mrow><mi>−</mi><mn>1</mn></mrow></msup><msup><mi>X</mi><mi>⊤</mi></msup><mi>W</mi><mo stretchy="true" form="postfix">)</mo></mrow><msubsup><mi>S</mi><mi>i</mi><mi>⊤</mi></msubsup><mo>=</mo><mrow><mo stretchy="true" form="prefix">(</mo><mi>I</mi><mo>−</mo><msup><mi>L</mi><mi>⊤</mi></msup><mi>X</mi><msup><mrow><mo stretchy="true" form="prefix">(</mo><msup><mi>X</mi><mi>⊤</mi></msup><mi>W</mi><mi>X</mi><mo stretchy="true" form="postfix">)</mo></mrow><mrow><mi>−</mi><mn>1</mn></mrow></msup><msup><mi>X</mi><mi>⊤</mi></msup><mi>L</mi><mo stretchy="true" form="postfix">)</mo></mrow><msubsup><mi>S</mi><mi>i</mi><mi>⊤</mi></msubsup><msubsup><mi>L</mi><mi>i</mi><mrow><mi>−</mi><mn>1</mn></mrow></msubsup></mrow><annotation encoding="application/x-tex">
  L^{-1} (I - X(X^\top W X)^{-1}X^\top W) S_i^\top = (I - L^\top X(X^\top W X)^{-1}X^\top L) S_i^\top L_i^{-1}
</annotation></semantics></math></p>
<p>Apparently</p>
<p><math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msup><mi>L</mi><mrow><mi>−</mi><mn>1</mn></mrow></msup><mrow><mo stretchy="true" form="prefix">(</mo><mi>I</mi><mo>−</mo><mi>X</mi><msup><mrow><mo stretchy="true" form="prefix">(</mo><msup><mi>X</mi><mi>⊤</mi></msup><mi>W</mi><mi>X</mi><mo stretchy="true" form="postfix">)</mo></mrow><mrow><mi>−</mi><mn>1</mn></mrow></msup><msup><mi>X</mi><mi>⊤</mi></msup><mi>W</mi><mo stretchy="true" form="postfix">)</mo></mrow><msubsup><mi>S</mi><mi>i</mi><mi>⊤</mi></msubsup><mo>=</mo><msup><mi>L</mi><mrow><mi>−</mi><mn>1</mn></mrow></msup><msubsup><mi>S</mi><mi>i</mi><mi>⊤</mi></msubsup><mo>−</mo><msup><mi>L</mi><mrow><mi>−</mi><mn>1</mn></mrow></msup><mi>X</mi><msup><mrow><mo stretchy="true" form="prefix">(</mo><msup><mi>X</mi><mi>⊤</mi></msup><mi>W</mi><mi>X</mi><mo stretchy="true" form="postfix">)</mo></mrow><mrow><mi>−</mi><mn>1</mn></mrow></msup><msubsup><mi>X</mi><mi>i</mi><mi>⊤</mi></msubsup><msub><mi>W</mi><mi>i</mi></msub></mrow><annotation encoding="application/x-tex">
  L^{-1} (I - X(X^\top W X)^{-1}X^\top W) S_i^\top = L^{-1} S_i^\top - L^{-1} X(X^\top W X)^{-1}X_i^\top W_i
</annotation></semantics></math></p>
<p><math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mrow><mo stretchy="true" form="prefix">(</mo><mi>I</mi><mo>−</mo><msup><mi>L</mi><mi>⊤</mi></msup><mi>X</mi><msup><mrow><mo stretchy="true" form="prefix">(</mo><msup><mi>X</mi><mi>⊤</mi></msup><mi>W</mi><mi>X</mi><mo stretchy="true" form="postfix">)</mo></mrow><mrow><mi>−</mi><mn>1</mn></mrow></msup><msup><mi>X</mi><mi>⊤</mi></msup><mi>L</mi><mo stretchy="true" form="postfix">)</mo></mrow><msubsup><mi>S</mi><mi>i</mi><mi>⊤</mi></msubsup><msubsup><mi>L</mi><mi>i</mi><mrow><mi>−</mi><mn>1</mn></mrow></msubsup><mo>=</mo><msubsup><mi>S</mi><mi>i</mi><mi>⊤</mi></msubsup><msubsup><mi>L</mi><mi>i</mi><mrow><mi>−</mi><mn>1</mn></mrow></msubsup><mo>−</mo><msup><mi>L</mi><mi>⊤</mi></msup><mi>X</mi><msup><mrow><mo stretchy="true" form="prefix">(</mo><msup><mi>X</mi><mi>⊤</mi></msup><mi>W</mi><mi>X</mi><mo stretchy="true" form="postfix">)</mo></mrow><mrow><mi>−</mi><mn>1</mn></mrow></msup><msubsup><mi>X</mi><mi>i</mi><mi>⊤</mi></msubsup></mrow><annotation encoding="application/x-tex">
  (I - L^\top X(X^\top W X)^{-1}X^\top L) S_i^\top L_i^{-1} = S_i^\top L_i^{-1} - L^\top X(X^\top W X)^{-1}X_i^\top
</annotation></semantics></math></p>
<p>And obviously
<math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msup><mi>L</mi><mrow><mi>−</mi><mn>1</mn></mrow></msup><msubsup><mi>S</mi><mi>i</mi><mi>⊤</mi></msubsup><mo>=</mo><msubsup><mi>S</mi><mi>i</mi><mi>⊤</mi></msubsup><msubsup><mi>L</mi><mi>i</mi><mrow><mi>−</mi><mn>1</mn></mrow></msubsup></mrow><annotation encoding="application/x-tex">
  L^{-1} S_i^\top = S_i^\top L_i^{-1}
</annotation></semantics></math></p>
<p><math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msup><mi>L</mi><mrow><mi>−</mi><mn>1</mn></mrow></msup><mi>X</mi><msup><mrow><mo stretchy="true" form="prefix">(</mo><msup><mi>X</mi><mi>⊤</mi></msup><mi>W</mi><mi>X</mi><mo stretchy="true" form="postfix">)</mo></mrow><mrow><mi>−</mi><mn>1</mn></mrow></msup><msub><mi>X</mi><mi>i</mi></msub><msub><mi>W</mi><mi>i</mi></msub><mo>=</mo><msup><mi>L</mi><mi>⊤</mi></msup><mi>X</mi><msup><mrow><mo stretchy="true" form="prefix">(</mo><msup><mi>X</mi><mi>⊤</mi></msup><mi>W</mi><mi>X</mi><mo stretchy="true" form="postfix">)</mo></mrow><mrow><mi>−</mi><mn>1</mn></mrow></msup><msubsup><mi>X</mi><mi>i</mi><mi>⊤</mi></msubsup></mrow><annotation encoding="application/x-tex">
  L^{-1} X(X^\top W X)^{-1}X_i W_i = L^\top X(X^\top W X)^{-1}X_i^\top
</annotation></semantics></math></p>
<p>because of the following <span class="math display">$$
  (X(X^\top W X)^{-1}X_i W_i)_{i} = X_i(X^\top W X)^{-1}X_i W_i \\
  = W_i X_i(X^\top W X)^{-1}X_i^\top \\
  = (W X(X^\top W X)^{-1}X_i^\top)_{i}
$$</span></p>
</div>
</div>
</div>
<div class="section level2">
<h2 id="special-considerations-in-implementations">Special Considerations in Implementations<a class="anchor" aria-label="anchor" href="#special-considerations-in-implementations"></a>
</h2>
<div class="section level3">
<h3 id="pseudo-inverse-of-a-matrix">Pseudo Inverse of a Matrix<a class="anchor" aria-label="anchor" href="#pseudo-inverse-of-a-matrix"></a>
</h3>
<p>Empirical covariance matrix is involved with the inverse of a matrix,
or symmetric square root of a matrix. To calculate this, we usually
requires that the matrix is positive-definite. However, <span class="citation">Young (2016)</span> suggest that this is not always
assured in practice.</p>
<p>Thus, following <span class="citation">Pustejovsky and Tipton
(2018)</span>, we use the pseudo inverse to avoid this. We follow the
following logic (see the corresponding <code>C++</code> function
<code>pseudoInverseSqrt</code>) to obtain the pseudo inverse:</p>
<ol style="list-style-type: decimal">
<li>Conduct singular value decomposition.</li>
<li>Use <code>cpow</code> to obtain the square root of the reciprocals
of singular values, if the value is larger than a computational
threshold; otherwise replace the value with 0.</li>
<li>Reconstruct the pseudo inverse matrix from modified singular values
and U/V matrix.</li>
</ol>
<p>In <code>Eigen</code> package, the pseudo inverse method is already
implemented in <a href="https://libeigen.gitlab.io/docs/classEigen_1_1CompleteOrthogonalDecomposition.html#a6260bd1050a28dd59733233d93eb6bed" class="external-link"><code>Eigen::CompleteOrthogonalDecomposition&lt; MatrixType_ &gt;::pseudoInverse</code></a>,
but it is not used for the following reason:</p>
<ol style="list-style-type: decimal">
<li>The pseudo inverse method is not stable and can lead to
<code>NAN</code> in calculations.</li>
<li>To find out the symmetric square root, singular value decomposition
is still needed, so not using the method but instead calculating
directly the square root of the pseudo inverse can be simpler.</li>
</ol>
</div>
</div>
<div class="section level2">
<h2 class="unnumbered" id="references">References<a class="anchor" aria-label="anchor" href="#references"></a>
</h2>
<div id="refs" class="references csl-bib-body hanging-indent" entry-spacing="0" line-spacing="2">
<div id="ref-bell2002bias" class="csl-entry">
Bell RM, McCaffrey DF (2002). <span>“Bias Reduction in Standard Errors
for Linear Regression with Multi-Stage Samples.”</span> <em>Survey
Methodology</em>, <strong>28</strong>(2), 169–182.
</div>
<div id="ref-pustejovsky2018small" class="csl-entry">
Pustejovsky JE, Tipton E (2018). <span>“Small-Sample Methods for
Cluster-Robust Variance Estimation and Hypothesis Testing in Fixed
Effects Models.”</span> <em>Journal of Business &amp; Economic
Statistics</em>, <strong>36</strong>(4), 672–683.
</div>
<div id="ref-young2016improved" class="csl-entry">
Young A (2016). <span>“Improved, Nearly Exact, Statistical Inference
with Robust and Clustered Covariance Matrices Using Effective Degrees of
Freedom Corrections.”</span> <em>Manuscript, London School of
Economics</em>,. Retrieved from <a href="https://personal.lse.ac.uk/YoungA/Improved.pdf" class="external-link">https://personal.lse.ac.uk/YoungA/Improved.pdf</a>
</div>
</div>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by Daniel Sabanes Bove, Liming Li, Julia Dedic, Doug Kelkhoff, Kevin Kunzmann, Brian Matthew Lang, Christian Stock, Ya Wang, Dan James, Jonathan Sidi, Daniel Leibovitz, Daniel D. Sjoberg, Boehringer Ingelheim Ltd., Gilead Sciences, Inc., F. Hoffmann-La Roche AG, Merck Sharp &amp; Dohme, Inc., AstraZeneca plc, inferential.biostatistics GmbH.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.1.</p>
</div>

    </footer>
</div>





  </body>
</html>
