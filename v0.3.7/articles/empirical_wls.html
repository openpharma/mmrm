<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="description" content="mmrm">
<title>Details of Weighted Least Square Empirical Covariance • mmrm</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="16x16" href="../favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="../favicon-32x32.png">
<link rel="apple-touch-icon" type="image/png" sizes="180x180" href="../apple-touch-icon.png">
<link rel="apple-touch-icon" type="image/png" sizes="120x120" href="../apple-touch-icon-120x120.png">
<link rel="apple-touch-icon" type="image/png" sizes="76x76" href="../apple-touch-icon-76x76.png">
<link rel="apple-touch-icon" type="image/png" sizes="60x60" href="../apple-touch-icon-60x60.png">
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.2.2/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.2.2/bootstrap.bundle.min.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- bootstrap-toc --><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@v1.0.1/dist/bootstrap-toc.min.js" integrity="sha256-4veVQbu7//Lk5TSmc7YV48MxtMy98e26cf5MrgZYnwo=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- search --><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Details of Weighted Least Square Empirical Covariance">
<meta property="og:description" content="mmrm">
<meta property="og:image" content="https://openpharma.github.io/mmrm/logo.svg">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]--><!-- Global site tag (gtag.js) - Google Analytics --><script async src="https://www.googletagmanager.com/gtag/js?id=UA-125641273-1"></script><script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-125641273-1');
</script>
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>
    

    <nav class="navbar fixed-top navbar-light navbar-expand-lg bg-light"><div class="container">
    
    <a class="navbar-brand me-2" href="../index.html">mmrm</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.3.7</small>

    
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item">
  <a class="nav-link" href="../reference/index.html">Reference</a>
</li>
<li class="active nav-item dropdown">
  <a href="#" class="nav-link dropdown-toggle" data-bs-toggle="dropdown" role="button" aria-expanded="false" aria-haspopup="true" id="dropdown-articles">Articles</a>
  <div class="dropdown-menu" aria-labelledby="dropdown-articles">
    <h6 class="dropdown-header" data-toc-skip>Introduction</h6>
    <a class="dropdown-item" href="../articles/introduction.html">Package Introduction</a>
    <a class="dropdown-item" href="../articles/methodological_introduction.html">Mixed Models for Repeated Measures</a>
    <a class="dropdown-item" href="../articles/mmrm_review_methods.html">Comparison with other software</a>
    <div class="dropdown-divider"></div>
    <h6 class="dropdown-header" data-toc-skip>Covariance Structures</h6>
    <a class="dropdown-item" href="../articles/covariance.html">Covariance Structures</a>
    <div class="dropdown-divider"></div>
    <h6 class="dropdown-header" data-toc-skip>Degrees of Freedom</h6>
    <a class="dropdown-item" href="../articles/between_within.html">Between-Within</a>
    <a class="dropdown-item" href="../articles/kenward.html">Kenward-Roger</a>
    <a class="dropdown-item" href="../articles/satterthwaite.html">Satterthwaite</a>
    <div class="dropdown-divider"></div>
    <h6 class="dropdown-header" data-toc-skip>Coefficient Covariance</h6>
    <a class="dropdown-item" href="../articles/coef_vcov.html">Coefficients Covariance Matrix Adjustment</a>
    <a class="dropdown-item" href="../articles/empirical_wls.html">Details of Weighted Least Square Empirical Covariance</a>
    <div class="dropdown-divider"></div>
    <h6 class="dropdown-header" data-toc-skip>Algorithm Details</h6>
    <a class="dropdown-item" href="../articles/algorithm.html">Model Fitting Algorithm</a>
    <a class="dropdown-item" href="../articles/predict.html">Prediction and Simulation</a>
    <div class="dropdown-divider"></div>
    <h6 class="dropdown-header" data-toc-skip>Developers</h6>
    <a class="dropdown-item" href="../articles/package_structure.html">Package Structure</a>
  </div>
</li>
<li class="nav-item">
  <a class="nav-link" href="../news/index.html">Changelog</a>
</li>
<!-- start dropdown for versions --> <li class="nav-item dropdown">
        <a href="#" class="nav-link dropdown-toggle"
          data-bs-toggle="dropdown" role="button"
          aria-expanded="false" aria-haspopup="true"
          id="dropdown-versions">Versions</a> <div class="dropdown-menu" aria-labelledby="dropdown-versions"> <a class="dropdown-item" data-toggle="tooltip" title="" href="https://openpharma.github.io/mmrm/latest-tag">latest-tag</a>
<a class="dropdown-item" data-toggle="tooltip" title="" href="https://openpharma.github.io/mmrm/main">main</a>
<a class="dropdown-item" data-toggle="tooltip" title="" href="https://openpharma.github.io/mmrm/v0.3.11">v0.3.11</a>
<a class="dropdown-item" data-toggle="tooltip" title="" href="https://openpharma.github.io/mmrm/v0.3.10">v0.3.10</a>
<a class="dropdown-item" data-toggle="tooltip" title="" href="https://openpharma.github.io/mmrm/v0.3.7">v0.3.7</a>
<a class="dropdown-item" data-toggle="tooltip" title="" href="https://openpharma.github.io/mmrm/v0.3.6">v0.3.6</a>
<a class="dropdown-item" data-toggle="tooltip" title="" href="https://openpharma.github.io/mmrm/v0.3.5">v0.3.5</a>
<a class="dropdown-item" data-toggle="tooltip" title="" href="https://openpharma.github.io/mmrm/v0.3.4">v0.3.4</a>
<a class="dropdown-item" data-toggle="tooltip" title="" href="https://openpharma.github.io/mmrm/v0.3.3">v0.3.3</a>
<a class="dropdown-item" data-toggle="tooltip" title="" href="https://openpharma.github.io/mmrm/v0.3.2">v0.3.2</a>
<a class="dropdown-item" data-toggle="tooltip" title="" href="https://openpharma.github.io/mmrm/v0.3.1">v0.3.1</a>
<a class="dropdown-item" data-toggle="tooltip" title="" href="https://openpharma.github.io/mmrm/v0.3.0">v0.3.0</a>
<a class="dropdown-item" data-toggle="tooltip" title="" href="https://openpharma.github.io/mmrm/v0.2.2">v0.2.2</a> </div></li>
<!-- end dropdown for versions -->
<li class="nav-item dropdown">
  <a href="#" class="nav-link dropdown-toggle" data-bs-toggle="dropdown" role="button" aria-expanded="false" aria-haspopup="true" id="dropdown-reports">Reports</a>
  <div class="dropdown-menu" aria-labelledby="dropdown-reports">
    <a class="dropdown-item" href="../coverage-report/">Coverage report</a>
    <a class="dropdown-item" href="../unit-test-report/">Unit test report</a>
  </div>
</li>
      </ul>
<form class="form-inline my-2 my-lg-0" role="search">
        <input type="search" class="form-control me-sm-2" aria-label="Toggle navigation" name="search-input" data-search-index="../search.json" id="search-input" placeholder="Search for" autocomplete="off">
</form>

      <ul class="navbar-nav">
<li class="nav-item">
  <a class="external-link nav-link" href="https://github.com/openpharma/mmrm">
    <span class="fa fa-github"></span>
     
  </a>
</li>
      </ul>
</div>

    
  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="../logo.svg" class="logo" alt=""><h1>Details of Weighted Least Square Empirical Covariance</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/openpharma/mmrm/blob/HEAD/vignettes/empirical_wls.Rmd" class="external-link"><code>vignettes/empirical_wls.Rmd</code></a></small>
      <div class="d-none name"><code>empirical_wls.Rmd</code></div>
    </div>

    
    
<div class="section level2">
<h2 id="weighted-least-square-wls-empirical-covariance">Weighted Least Square (WLS) Empirical Covariance<a class="anchor" aria-label="anchor" href="#weighted-least-square-wls-empirical-covariance"></a>
</h2>
<p>Following the notation we have without weights, <span class="citation">Bell and McCaffrey (2002)</span> and <span class="citation">Pustejovsky and Tipton (2018)</span> suggest</p>
<p><span class="math display">\[
  v = s C^\top(X^\top W X)^{-1}\sum_{i}{X_i^\top W_i A_i \epsilon_i
\epsilon_i^\top A_i W_i X_i} (X^\top W X)^{-1} C
\]</span></p>
<p>where <span class="math inline">\(A_i\)</span> takes <span class="math inline">\(I_i\)</span>, <span class="math inline">\((I_i -
H_{ii})^{-\frac{1}{2}}\)</span>, or <span class="math inline">\((I_i -
H_{ii})^{-1}\)</span> is unchanged, but <span class="math inline">\(H\)</span> is changed</p>
<p><span class="math display">\[
  H = X (X^\top W X)^{-1} X^\top W
\]</span></p>
<p>For the degrees of freedom, we have</p>
<p><span class="math display">\[
  G_{ij} = g_i^\top \Phi g_j
\]</span></p>
<p>where</p>
<p><span class="math display">\[
  g_i = s^{\frac{1}{2}} (I - H)_i^\top A_i W_i X_i (X^\top X)^{-1} C
\]</span></p>
</div>
<div class="section level2">
<h2 id="difference-of-implementations">Difference of Implementations<a class="anchor" aria-label="anchor" href="#difference-of-implementations"></a>
</h2>
<p>Comparing the previous section with our implementation, we can find
out the differences. Since they have nearly the same symbols, to
differentiate the different part, we use subscript <span class="math inline">\(1\)</span> to denote the implementation suggested
by <span class="citation">Bell and McCaffrey (2002)</span> and <span class="citation">Pustejovsky and Tipton (2018)</span>, and use <span class="math inline">\(2\)</span> to denote the our implementation of
covariance estimator in <code>mmrm</code>, we have</p>
<p><span class="math display">\[
  v_{1} = s C^\top(X^\top W X)^{-1}\sum_{i}{X_i^\top W_i A_{1, i}
\epsilon_i \epsilon_i^\top A_{1, i} W_i X_i} (X^\top W X)^{-1} C
\]</span></p>
<p><span class="math display">\[
  v_{2} = s C^\top(X^\top W X)^{-1}\sum_{i}{X_i^\top L_i A_{2, i}
L_i^\top \epsilon_i \epsilon_i^\top L_i A_{2, i} L_i^\top X_i} (X^\top W
X)^{-1} C
\]</span></p>
<p>Here we will prove that they are identical.</p>
<div class="section level3">
<h3 id="proof-of-identity">Proof of Identity<a class="anchor" aria-label="anchor" href="#proof-of-identity"></a>
</h3>
<div class="section level4">
<h4 id="proof-for-covariance-estimator">Proof for Covariance Estimator<a class="anchor" aria-label="anchor" href="#proof-for-covariance-estimator"></a>
</h4>
<p>First of all, we assume that all <span class="math inline">\(A_i\)</span> matrix, in any form, are
positive-definite. Comparing <span class="math inline">\(v_{1}\)</span>
and <span class="math inline">\(v_{2}\)</span>, we see that the
different part is</p>
<p><span class="math display">\[
  M_{1, d, i} = W_i A_{1, i}
\]</span> and <span class="math display">\[
  M_{2, d, i} = L_i A_{2, i} L_i^\top
\]</span></p>
<p>Substitute <span class="math inline">\(H_{1}\)</span> and <span class="math inline">\(H_{2}\)</span> with its expression, we have</p>
<p><span class="math display">\[
  M_{1, d, i} = W_i (I_i - X_i (X^\top W X)^{-1} X_i^\top W_i)^d
\]</span></p>
<p><span class="math display">\[
  M_{2, d, i} = L_i (I_i - L_i^\top X_i (X^\top W X)^{-1} X_i^\top
L_i)^d L_i^\top
\]</span></p>
<p>Where <span class="math inline">\(d\)</span> takes <span class="math inline">\(0\)</span>, <span class="math inline">\(-1/2\)</span> and <span class="math inline">\(-1\)</span> respectively.</p>
<p>Apparently, if <span class="math inline">\(d=0\)</span>, these two
are identical because <span class="math inline">\(W_i = L_i
L_i^\top\)</span>.</p>
<p>When <span class="math inline">\(d = -1\)</span>, we have</p>
<p><span class="math display">\[
  M_{2, -1, i} = L_i (I_i - L_i^\top X_i (X^\top W X)^{-1} X_i^\top
L_i)^{-1} L_i^\top \\
  = (L_i^{-1})^{-1} (I_i - L_i^\top X_i (X^\top W X)^{-1} X_i^\top
L_i)^{-1} ((L_i^\top)^{-1})^{-1} \\
  = [((L_i^\top)^{-1})(I_i - L_i^\top X_i (X^\top W X)^{-1} X_i^\top
L_i)(L_i^{-1})]^{-1} \\
  = [(L_i^\top)^{-1}L_i^{-1} - X_i (X^\top W X)^{-1} X_i^\top]^{-1} \\
  = (W_i^{-1} -  X_i (X^\top W X)^{-1} X_i^\top)^{-1}
\]</span></p>
<p><span class="math display">\[
  M_{1, -1, i} = W_i (I_i - X_i (X^\top W X)^{-1} X_i^\top W_i)^{-1} \\
  = (W_i^{-1})^{-1} (I_i - X_i (X^\top W X)^{-1} X_i^\top W_i)^{-1} \\
  = [(I_i - X_i (X^\top W X)^{-1} X_i^\top W_i)((W_i^{-1}))]^{-1} \\
  = (W_i^{-1} -  X_i (X^\top W X)^{-1} X_i^\top)^{-1}
\]</span></p>
<p>Obviously, <span class="math inline">\(M_{2, -1, i} = M_{1, -1,
i}\)</span>, and use the following notation</p>
<p><span class="math display">\[
  M_{2, -1, i} = L_i B_{2, i} L_i^\top
\]</span></p>
<p><span class="math display">\[
  M_{1, -1, i} = W_i B_{1, i}
\]</span></p>
<p>we have</p>
<p><span class="math display">\[
  B_{1, i} = W_i^{-1} L_i B_{2, i} L_i^\top \\
  = (L_i^\top)^{-1} B_{2, i} L_i^\top
\]</span></p>
<p>When <span class="math inline">\(d = -1/2\)</span>, we have the
following</p>
<p><span class="math display">\[
  M_{2, -1/2, i} = L_i (I_i - L_i^\top X_i (X^\top W X)^{-1} X_i^\top
L_i)^{-1/2} L_i^\top \\
  = L_i B_{2, i}^{1/2} L_i^\top
\]</span></p>
<p><span class="math display">\[
  M_{1, -1/2, i} = W_i (I_i - X_i (X^\top W X)^{-1} X_i^\top W_i)^{-1/2}
\\
  = W_i B_{1, i}^{1/2}
\]</span></p>
<p>Apparently if <span class="math inline">\(B_{1, i}^{1/2} \ne
(L_i^\top)^{-1} B_{2, i}^{1/2} L_i^\top\)</span>, we should also have
<span class="math display">\[
  B_{1, i}^{1/2} B_{1, i}^{1/2} \ne (L_i^\top)^{-1} B_{2, i}^{1/2}
L_i^\top (L_i^\top)^{-1} B_{2, i}^{1/2} L_i^\top
\]</span></p>
<p>leading to</p>
<p><span class="math display">\[
  B_{1, i} \ne (L_i^\top)^{-1} B_{2, i} L_i^\top
\]</span></p>
<p>which is contradictory with our previous result. Thus, these
covariance estimator are identical.</p>
</div>
<div class="section level4">
<h4 id="proof-for-degrees-of-freedom">Proof for Degrees of Freedom<a class="anchor" aria-label="anchor" href="#proof-for-degrees-of-freedom"></a>
</h4>
<p>To prove <span class="math display">\[
  G_{1, ij} = g_{1, i}^\top \Phi g_{1, j}
\]</span> and <span class="math display">\[
  G_{2, ij} = g_{2, i}^\top g_{2, j}
\]</span> are identical, we only need to prove that</p>
<p><span class="math display">\[
  L^{-1} g_{1, i} = g_{mmrm_i}
\]</span></p>
<p>where <span class="math inline">\(\Phi = W^{-1}\)</span> according to
our previous expression.</p>
<p>We first expand <span class="math inline">\(L^{-1} g_{1, i}\)</span>
and <span class="math inline">\(g_{mmrm_i}\)</span></p>
<p><span class="math display">\[
  L^{-1} g_{1, i} = L^{-1} (I - X(X^\top W X)^{-1}X^\top W) S_i^\top
A_{1, i}^d W_i X_i (X^\top W X)^{-1} C
\]</span></p>
<p><span class="math display">\[
  g_{2, i} = (I - L_i^\top X(X^\top W X)^{-1}X^\top L_i) S_i^\top A_{2,
i}^d L_i^\top X_i (X^\top W X)^{-1} C
\]</span></p>
<p>where <span class="math inline">\(S_i\)</span> is the row selection
matrix.</p>
<p>We will prove the inner part equal <span class="math display">\[
  L^{-1} (I - X(X^\top W X)^{-1}X^\top W) S_i^\top A_{1, i}^d W_i = (I -
L^\top X(X^\top W X)^{-1}X^\top L) S_i^\top A_{2, i}^d L_i^\top
\]</span></p>
<p>With the previous proof of covariance estimators, we already have</p>
<p><span class="math display">\[
  M_{1, d, i} = W_i A_{1, i}^d = L_i A_{2, i}^d L_i^\top = M_{2, d, i}
\]</span> we then need to prove <span class="math display">\[
  L^{-1} (I - X(X^\top W X)^{-1}X^\top W) S_i^\top = (I - L^\top
X(X^\top W X)^{-1}X^\top L) S_i^\top L_i^{-1}
\]</span></p>
<p>and note the relationship between <span class="math inline">\((I -
X(X^\top W X)^{-1}X^\top W)\)</span> and <span class="math inline">\((I
- L^\top X(X^\top W X)^{-1}X^\top L)\)</span> has already been proved in
covariance estimator section, we only need to prove</p>
<p><span class="math display">\[
  L^{-1} (I - X(X^\top W X)^{-1}X^\top W) S_i^\top = (I - L^\top
X(X^\top W X)^{-1}X^\top L) S_i^\top L_i^{-1}
\]</span></p>
<p>Apparently</p>
<p><span class="math display">\[
  L^{-1} (I - X(X^\top W X)^{-1}X^\top W) S_i^\top = L^{-1} S_i^\top -
L^{-1} X(X^\top W X)^{-1}X_i^\top W_i
\]</span></p>
<p><span class="math display">\[
  (I - L^\top X(X^\top W X)^{-1}X^\top L) S_i^\top L_i^{-1} = S_i^\top
L_i^{-1} - L^\top X(X^\top W X)^{-1}X_i^\top
\]</span></p>
<p>And obviously <span class="math display">\[
  L^{-1} S_i^\top = S_i^\top L_i^{-1}
\]</span></p>
<p><span class="math display">\[
  L^{-1} X(X^\top W X)^{-1}X_i W_i = L^\top X(X^\top W X)^{-1}X_i^\top
\]</span></p>
<p>because of the following <span class="math display">\[
  (X(X^\top W X)^{-1}X_i W_i)_{i} = X_i(X^\top W X)^{-1}X_i W_i \\
  = W_i X_i(X^\top W X)^{-1}X_i^\top \\
  = (W X(X^\top W X)^{-1}X_i^\top)_{i}
\]</span></p>
</div>
</div>
</div>
<div class="section level2">
<h2 id="special-considerations-in-implementations">Special Considerations in Implementations<a class="anchor" aria-label="anchor" href="#special-considerations-in-implementations"></a>
</h2>
<div class="section level3">
<h3 id="pseudo-inverse-of-a-matrix">Pseudo Inverse of a Matrix<a class="anchor" aria-label="anchor" href="#pseudo-inverse-of-a-matrix"></a>
</h3>
<p>Empirical covariance matrix is involved with the inverse of a matrix,
or symmetric square root of a matrix. To calculate this, we usually
requires that the matrix is positive-definite. However, <span class="citation">Young (2016)</span> suggest that this is not always
assured in practice.</p>
<p>Thus, following <span class="citation">Pustejovsky and Tipton
(2018)</span>, we use the pseudo inverse to avoid this. We follow the
following logic (see the corresponding <code>C++</code> function
<code>pseudoInverseSqrt</code>) to obtain the pseudo inverse:</p>
<ol style="list-style-type: decimal">
<li>Conduct singular value decomposition.</li>
<li>Use <code>cpow</code> to obtain the square root of the reciprocals
of singular values, if the value is larger than a computational
threshold; otherwise replace the value with 0.</li>
<li>Reconstruct the pseudo inverse matrix from modified singular values
and U/V matrix.</li>
</ol>
<p>In <code>Eigen</code> package, the pseudo inverse method is already
implemented in <a href="https://eigen.tuxfamily.org/dox/classEigen_1_1CompleteOrthogonalDecomposition.html#ab5e8b3f2c7b602772e1f1d7ce63d446e" class="external-link"><code>Eigen::CompleteOrthogonalDecomposition&lt; MatrixType_ &gt;::pseudoInverse</code></a>,
but it is not used for the following reason:</p>
<ol style="list-style-type: decimal">
<li>The pseudo inverse method is not stable and can lead to
<code>NAN</code> in calculations.</li>
<li>To find out the symmetric square root, singular value decomposition
is still needed, so not using the method but instead calculating
directly the square root of the pseudo inverse can be simpler.</li>
</ol>
</div>
</div>
<div class="section level2">
<h2 class="unnumbered" id="references">References<a class="anchor" aria-label="anchor" href="#references"></a>
</h2>
<div id="refs" class="references csl-bib-body hanging-indent" line-spacing="2">
<div id="ref-bell2002bias" class="csl-entry">
Bell RM, McCaffrey DF (2002). <span>“Bias Reduction in Standard Errors
for Linear Regression with Multi-Stage Samples.”</span> <em>Survey
Methodology</em>, <strong>28</strong>(2), 169–182.
</div>
<div id="ref-pustejovsky2018small" class="csl-entry">
Pustejovsky JE, Tipton E (2018). <span>“Small-Sample Methods for
Cluster-Robust Variance Estimation and Hypothesis Testing in Fixed
Effects Models.”</span> <em>Journal of Business &amp; Economic
Statistics</em>, <strong>36</strong>(4), 672–683.
</div>
<div id="ref-young2016improved" class="csl-entry">
Young A (2016). <span>“Improved, Nearly Exact, Statistical Inference
with Robust and Clustered Covariance Matrices Using Effective Degrees of
Freedom Corrections.”</span> <em>Manuscript, London School of
Economics</em>,. Retrieved from <a href="https://personal.lse.ac.uk/YoungA/Improved.pdf" class="external-link">https://personal.lse.ac.uk/YoungA/Improved.pdf</a>
</div>
</div>
</div>
  </main><aside class="col-md-3"><nav id="toc"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p></p>
<p>Developed by Daniel Sabanes Bove, Julia Dedic, Doug Kelkhoff, Kevin Kunzmann, Brian Matthew Lang, Liming Li, Christian Stock, Ya Wang, Dan James, Jonathan Sidi, Daniel Leibovitz, Daniel D. Sjoberg, Boehringer Ingelheim Ltd., Gilead Sciences, Inc., F. Hoffmann-La Roche AG, Merck Sharp &amp; Dohme, Inc., AstraZeneca plc.</p>
</div>

<div class="pkgdown-footer-right">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.7.</p>
</div>

    </footer>
</div>

  

  

  </body>
</html>
